<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #000;
      color: #fff;
      margin: 0;
      padding: 40px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background-color: #000;
      padding: 20px 40px;
      z-index: 999;
    }

    header img {
      height: 70px;
    }

    h2 {
      text-align: center;
      font-size: 28px;
      margin: 20px 0;
      color: #FFD700;
    }

    form {
      max-width: 1000px;
      margin: 0 auto;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: bold;
      margin-bottom: 5px;
      color: #fff;
    }

    input {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #FFD700;
      font-size: 14px;
      background-color: #111;
      color: #fff;
    }

    input::placeholder {
      color: #aaa;
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    #descricao {
      grid-column: span 3;
    }

    .buttons {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }

    button {
      font-weight: bold;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    #calcularBtn {
      background-color: #FFD700;
      color: #000;
    }

    #calcularBtn:disabled {
      opacity: 0.7;
      cursor: wait;
    }

    #limparBtn {
      background-color: red;
      color: #fff;
    }

    .bloco-resultado {
      background-color: #111;
      border: 2px solid #FFD700;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      overflow-x: auto;
    }

    .bloco-resultado table {
      width: 100%;
      border-collapse: collapse;
      color: #fff;
      text-align: center;
    }

    .bloco-resultado th {
      background-color: #000;
      color: #FFD700;
      padding: 10px;
      border: 1px solid #FFD700;
    }

    .bloco-resultado td {
      padding: 8px;
      border: 1px solid #444;
    }

    .bloco-resultado .bloco-titulo {
      font-weight: bold;
      font-size: 20px;
      color: #FFD700;
      margin-bottom: 10px;
      text-align: left;
    }
  </style>
</head>
<body>
  <header>
    <img src="https://raw.githubusercontent.com/altinoteixeira/simulador-altstreet/main/assetslogos/Logo%20Hurst.png" alt="Hurst Logo" />
    <img src="https://raw.githubusercontent.com/altinoteixeira/simulador-altstreet/main/assetslogos/Logo%Marques%Capital%JPEG.png" alt="Marques Capital Logo" />
  </header>

  <h2>Análise de Viabilidade de Investimento</h2>

  <form id="formulario">
    <div class="form-row">
      <div class="form-group" id="descricao">
        <label for="descricao">Descrição do Projeto</label>
        <input type="text" id="descricao" name="descricao" required />
      </div>

      <div class="form-group">
        <label for="prazoOperacao">Prazo Operação</label>
        <input type="number" id="prazoOperacao" name="prazoOperacao" placeholder="Em meses" required />
      </div>

      <div class="form-group">
        <label for="dataInicio">Data Início</label>
        <input type="text" id="dataInicio" name="dataInicio" placeholder="MM/AAAA" required />
      </div>

      <div class="form-group">
        <label for="precoAquisicao">Preço de Aquisição (€)</label>
        <input type="text" id="precoAquisicao" name="precoAquisicao" placeholder="400000" required />
      </div>

      <div class="form-group">
        <label for="tipologia">Tipologia(s)</label>
        <input type="text" id="tipologia" name="tipologia" required />
      </div>

      <div class="form-group">
        <label for="m2Habitacao">M² Habitação</label>
        <input type="number" id="m2Habitacao" name="m2Habitacao" required />
      </div>

      <div class="form-group">
        <label for="vlrM2Obras">Custo M² Obras</label>
        <input type="text" id="vlrM2Obras" name="vlrM2Obras" />
      </div>

      <div class="form-group">
        <label for="custosObra">Outros Custos Obras (€)</label>
        <input type="text" id="custosObra" name="custosObra" />
      </div>

      <div class="form-group">
        <label for="vlrM2Venda">Valor M² Venda (€)</label>
        <input type="text" id="vlrM2Venda" name="vlrM2Venda" />
      </div>

      <div class="form-group">
        <label for="vlrTotalVenda">Valor Total Venda (€)</label>
        <input type="text" id="vlrTotalVenda" name="vlrTotalVenda" />
      </div>

      <div class="form-group">
        <label for="comissao">% Comissão</label>
        <input type="text" id="comissao" name="comissao" placeholder="%" />
      </div>

      <div class="form-group">
        <label for="entradaFinanciamento">% Entrada Financiamento</label>
        <input type="text" id="entradaFinanciamento" name="entradaFinanciamento" placeholder="%" />
      </div>

      <div class="form-group">
        <label for="segurosMes">Seguros Mês (€)</label>
        <input type="text" id="segurosMes" name="segurosMes" />
      </div>

      <div class="form-group">
        <label for="condominioMes">Condomínio Mês (€)</label>
        <input type="text" id="condominioMes" name="condominioMes" />
      </div>

      <div class="form-group">
        <label for="luzMes">Luz Mês (€)</label>
        <input type="text" id="luzMes" name="luzMes" />
      </div>

      <div class="form-group">
        <label for="aguaMes">Água Mês (€)</label>
        <input type="text" id="aguaMes" name="aguaMes" />
      </div>
    </div>

    <div class="buttons">
      <button type="submit" id="calcularBtn">Calcular</button>
      <button type="button" id="limparBtn">Limpar</button>
    </div>

    <div id="resultados" style="margin-top: 60px;"></div>
  </form>

  <script>
    const camposMonetarios = [
      "precoAquisicao", "vlrM2Obras", "custosObra", "vlrM2Venda", "vlrTotalVenda",
      "segurosMes", "condominioMes", "luzMes", "aguaMes"
    ];
    const camposPercentuais = ["comissao", "entradaFinanciamento"];

    function removerMascara(valor) {
      return valor.replace(/\./g, "").replace(",", ".");
    }

    camposMonetarios.forEach(id => {
      const input = document.getElementById(id);
      input?.addEventListener("input", () => {
        let valor = input.value.replace(/\D/g, "");
        if (valor) {
          valor = parseInt(valor).toLocaleString("pt-PT");
        }
        input.value = valor;
      });
    });

    camposPercentuais.forEach(id => {
      const input = document.getElementById(id);
      input?.addEventListener("input", () => {
        input.value = input.value.replace(/\D/g, "");
      });
      input?.setAttribute("placeholder", "%");
    });

    document.getElementById("formulario").addEventListener("submit", function (e) {
      e.preventDefault();

      const btn = document.getElementById("calcularBtn");
      btn.disabled = true;
      btn.textContent = "Processando...";

      const dados = Object.fromEntries(new FormData(e.target).entries());

      // Remover máscara antes de enviar
      camposMonetarios.forEach(id => {
        if (dados[id]) dados[id] = removerMascara(dados[id]);
      });

      google.script.run
        .withSuccessHandler(idProjeto => {
          google.script.run
            .withSuccessHandler(blocos => {
              renderizarCards(blocos);
              btn.disabled = false;
              btn.textContent = "Calcular";
              document.getElementById("resultados").scrollIntoView({ behavior: "smooth" });
            })
            .obterResultadosSimulacao(idProjeto);
        })
        .salvarDadosProjeto(dados);
    });

    document.getElementById("limparBtn").addEventListener("click", () => {
      document.getElementById("formulario").reset();
      document.getElementById("resultados").innerHTML = "";
    });

    function renderizarCards(blocos) {
      const container = document.getElementById("resultados");
      container.innerHTML = "";

      for (const [titulo, valores] of Object.entries(blocos)) {
        const card = document.createElement("div");
        card.className = "bloco-resultado";

        const tituloHtml = `<div class="bloco-titulo">${titulo}</div>`;
        let tabelaHtml = `<table><thead><tr><th>Referência</th><th>Otimista</th><th>Realista</th><th>Pessimista</th></tr></thead><tbody>`;

        const nomesLinhas = obterNomeLinha(titulo);
        for (let i = 0; i < valores.length; i += 3) {
          tabelaHtml += `<tr>
            <td>${nomesLinhas[i / 3] || ""}</td>
            <td>${formatarValor(valores[i])}</td>
            <td>${formatarValor(valores[i + 1])}</td>
            <td>${formatarValor(valores[i + 2])}</td>
          </tr>`;
        }

        tabelaHtml += "</tbody></table>";
        card.innerHTML = tituloHtml + tabelaHtml;
        container.appendChild(card);
      }
    }

    function formatarValor(valor) {
      if (!valor) return "";
      if (!isNaN(parseFloat(valor))) {
        return parseFloat(valor).toLocaleString("pt-PT", { maximumFractionDigits: 2 });
      }
      return valor;
    }

    function obterNomeLinha(bloco) {
      return {
        "Resumo do Negócio": [
          "Prazo da Operação", "Preço da Aquisição", "Custos com Aquisição", "Custos com Financiamento",
          "Custos com as Obras", "Custos com Venda do imóvel", "Custos Transitórios", "Custo total do negócio",
          "Preço estimado de Venda", "Capital próprio necessário no negócio"
        ],
        "Análise de Rentabilidade Operação Plataforma": [
          "Receita bruta antes de impostos", "ROI Operação", "Captação Alvo da Operação", "Fee de Distribuição (%)",
          "Fee de Distribuição (€)", "Fee de Estruturação (%) c/IVA", "Fee de Estruturação (€) c/IVA",
          "Custo Total Operação", "Saldo (Captação - Custo Total)", "Lucro líquido antes de imposto"
        ],
        "Análise de Rentabilidade Investidor": [
          "Lucro líquido investidor (€)", "Lucro líquido investidor (%)", "Multiplicador (x)",
          "Payback (meses)", "Payback (%)"
        ],
        "Profit & Loss Originadora": [
          "Comissão Originadora", "Custo fixo mensal", "Custo fixo total", "Fee variada", "Fee de sucesso",
          "Total receitas", "Total custos", "Lucro bruto", "Margem de lucro (%)", "Impostos"
        ],
        "Distribuição dos Resultados (30/70)": [
          "Receita investidor", "Receita originadora", "Lucro líquido final", "Multiplicador final"
        ]
      }[bloco] || [];
    }
  </script>
</body>
</html>
